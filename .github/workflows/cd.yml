name: CD

on:
  push:
    branches: ["main"]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 - Backend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            pkill -f 'java -jar build/libs/project2-0.0.1-SNAPSHOT.jar' || true
            pkill -f 'npm start' || true
            sleep 2

            # ê¸°ì¡´ tmux ì„¸ì…˜ ì¢…ë£Œ
            tmux kill-session -t deploy_session || true
            sleep 2

            # ìƒˆ tmux ì„¸ì…˜ ì‹œì‘
            tmux new-session -d -s deploy_session || { echo "âŒ tmux ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨"; exit 1; }
            sleep 2  # tmux ì„¸ì…˜ ì•ˆì •í™” ëŒ€ê¸°

            # ì‘ì—… ë””ë ‰í† ë¦¬ ì§€ì •
            REPO_DIR="${GITHUB_WORKSPACE}"

            # Backend ì‘ì—…
            echo "ğŸ”„ Backend ë¹Œë“œ ë° ì‹¤í–‰ ì¤‘..."
            tmux send-keys "cd ${REPO_DIR}/backend" C-m
            tmux send-keys "./gradlew build -x test -Dorg.gradle.jvmargs=\"-Xmx256m\"" C-m

            # Spring ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
            tmux send-keys "cd ${REPO_DIR}/backend" C-m
            tmux send-keys "java -Xms64m -Xmx128m -jar build/libs/project2-0.0.1-SNAPSHOT.jar &" C-m
            echo "â³ Backend ì‹œì‘ ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
            sleep 10

            # Frontend ì‘ì—…ì„ ìœ„í•œ ìƒˆ tmux ì°½
            tmux new-window -t deploy_session:1 -n 'frontend'
            echo "ğŸ”„ Frontend ë¹Œë“œ ë° ì‹¤í–‰ ì¤‘..."

            # Frontend ë””ë ‰í† ë¦¬ì—ì„œ npm ëª…ë ¹ì–´ ì‹¤í–‰
            tmux send-keys "cd ${REPO_DIR}/frontend" C-m
            tmux send-keys "npm install" C-m

            # ë¹Œë“œ í›„ ë°±ê·¸ë¼ìš´ë“œë¡œ npm start ì‹¤í–‰
            tmux send-keys "cd ${REPO_DIR}/frontend && npm run build && npm start &" C-m

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ” ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
            if pgrep -f 'java -jar.*project2-0.0.1-SNAPSHOT.jar'; then
              echo "âœ… Backend ì •ìƒ ì‹¤í–‰ ì¤‘"
            else
              echo "âŒ Backend ì‹¤í–‰ ì‹¤íŒ¨"
              exit 1
            fi

            # ì™„ë£Œ ë©”ì‹œì§€
            echo "âœ… ë°°í¬ ì™„ë£Œ - tmux ì„¸ì…˜ 'deploy_session'ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
            echo "ì„¸ì…˜ ì ‘ì† ëª…ë ¹ì–´: tmux attach -t deploy_session"
