name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # ê¸°ì¡´ tmux ì„¸ì…˜ ì¢…ë£Œ
            tmux kill-session -t deploy_session || true
            sleep 2

            # ìƒˆ tmux ì„¸ì…˜ ì‹œì‘
            tmux new-session -d -s deploy_session || { echo "âŒ tmux ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨"; exit 1; }
            sleep 2

            REPO_DIR="/home/ec2-user/NBE4-5-2-Team04"

            # ìµœì‹  ì½”ë“œ pull
            tmux send-keys "cd ${REPO_DIR}" C-m
            tmux send-keys "git pull origin main" C-m
            sleep 2

            # ========================
            # ğŸ”§ Backend (Spring Boot)
            # ========================
            echo "ğŸ”„ Backend ë¹Œë“œ ë° ì‹¤í–‰ ì¤‘..."
            tmux send-keys "cd ${REPO_DIR}/backend" C-m
            tmux send-keys "./gradlew build -x test -Dorg.gradle.jvmargs='-Xmx256m'" C-m
            sleep 30

            tmux send-keys "cd ${REPO_DIR}/backend" C-m
            tmux send-keys "java -Xms64m -Xmx128m -jar build/libs/project2-0.0.1-SNAPSHOT.jar > /dev/null 2>&1 &" C-m
            sleep 30

            # ========================
            # ğŸ”§ Frontend (Next.js)
            # ========================
            tmux new-window -t deploy_session:1 -n 'frontend'
            echo "ğŸ”„ Frontend ë¹Œë“œ ë° ì‹¤í–‰ ì¤‘..."

            tmux send-keys "cd ${REPO_DIR}/frontend" C-m

            # ê¸°ì¡´ 3000 í¬íŠ¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            tmux send-keys "lsof -t -i:3000 | xargs kill -9 || true" C-m
            sleep 2

            # ì •ì  íŒŒì¼ ë° ìºì‹œ ì œê±°
            tmux send-keys "rm -rf .next" C-m

            # ì˜ì¡´ì„± ì„¤ì¹˜
            tmux send-keys "npm install" C-m
            sleep 5

            # ë¹Œë“œ í›„ PM2ë¡œ ì‹¤í–‰
            tmux send-keys "npm install -g pm2" C-m
            tmux send-keys "pm2 delete frontend-app || true" C-m
            tmux send-keys "npm run build" C-m
            sleep 10
            tmux send-keys "pm2 start npm --name frontend-app -- start" C-m

            echo "âœ… ë°°í¬ ì™„ë£Œ - tmux ì„¸ì…˜ 'deploy_session'ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
